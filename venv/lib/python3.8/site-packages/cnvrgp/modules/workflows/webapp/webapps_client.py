from cnvrgp.config.error_messages import NOT_A_DATASET_LIST_OBJECT
from cnvrgp.context import SCOPE
from cnvrgp.config import routes
from cnvrgp.errors import CnvrgArgumentsError

from cnvrgp.modules.base.workflows_base import WorkflowsBase
from cnvrgp.modules.dataset import Dataset
from cnvrgp.modules.workflows import Webapp
from cnvrgp.utils.validators import validate_types_in_list


class WebappsClient(WorkflowsBase):
    def __init__(self, project):
        super().__init__(Webapp, "Webapp", project._context)

        scope = self._context.get_scope(SCOPE.PROJECT)
        self._route = routes.WORKFLOWS_BASE.format(scope["organization"], scope["project"])

    def create(self, webapp_type, file_name, title=None, templates=None, datasets=None, *args, **kwargs):
        """
        Create a new webapp
        @param webapp_type: The type of webapp to create (shiny, dash or voila)
        @param file_name: The file for webapp creating
        @param title: Name of the webapp
        @param templates: List of template names to be used
        @param datasets: List of datasets to connect with the webapp.
        @param args: optional arguments
        @param kwargs: Dictionary. Rest of optional attributes for creation
            image: Image object to create webapp with
        TODO: Add a list of optional attributes
        @return: The newly created webapp object
        """

        kwargs = {
            "webapp_type": webapp_type,
            "file_name": file_name,
            **kwargs
        }

        if datasets and not validate_types_in_list(datasets, Dataset):
            raise CnvrgArgumentsError({"datasets": NOT_A_DATASET_LIST_OBJECT})
        elif datasets:
            kwargs["job_datasets"] = [ds.as_request_params() for ds in datasets]

        return super().create(title, templates, *args, **kwargs)
