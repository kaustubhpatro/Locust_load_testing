from datetime import datetime

from cnvrgp.config import routes
from cnvrgp.modules.base.workflow_instance_base import WorkflowInstanceBase
from cnvrgp.proxy import Proxy
from cnvrgp.context import Context, SCOPE


class WebappType:
    SHINY = "rshiny"
    DASH = "dash"
    VOILA = "voila"


class Webapp(WorkflowInstanceBase):

    available_attributes = {
        "webapp_type": str,
        "template_ids": list,
        "template_id": int,
        "compute": str,
        "num_of_exps": int,
        "updated_at": datetime,
        "iframe_url": str,
        "is_public": bool,
        "last_opened": datetime,
        "current_step": int,
        "strip_sources": bool,
        "copy_frequency": int,
        "file_name": str,
        "experiments": list,
        **WorkflowInstanceBase.available_attributes
    }

    def __init__(self, context=None, slug=None, attributes=None):
        self._context = Context(context=context)

        # Set current context scope to current project
        if slug:
            self._context.set_scope(SCOPE.WEBAPP, slug)

        scope = self._context.get_scope(SCOPE.WEBAPP)

        self._proxy = Proxy(context=self._context)
        self._route = routes.WORKFLOW_BASE.format(scope["organization"], scope["project"], scope["webapp"])
        self._attributes = attributes or {}
        self._type = "Webapp"
        self.slug = scope["webapp"]

    def sync(self, commit_msg=None):
        raise NotImplementedError()
